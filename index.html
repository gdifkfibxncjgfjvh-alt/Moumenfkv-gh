<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Saad merabet â€¢ Ù…Ù†ØµØ© Ø§Ù„Ø´Ø¹Ø¨</title>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  :root{
    --bg:#f5f6f7; --card:#ffffff; --border:#e9ecef; --text:#111;
    --muted:#6b7280; --brand:#111; --accent:#0ea5e9; --danger:#ef4444; --ok:#16a34a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif}

  /* NAV */
  .navbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;background:#fff;border-bottom:1px solid var(--border);padding:10px 14px;z-index:50}
  .logo{font-size:24px;letter-spacing:.2px;user-select:none}
  .logo .light{font-weight:300;color:#000}
  .logo .bold{font-weight:800;color:#000;margin-inline-start:3px}
  .nav-icons{display:flex;align-items:center;gap:12px}
  .icon{cursor:pointer;font-size:20px;padding:6px 10px;border-radius:10px;user-select:none}
  .icon.active{background:#111;color:#fff}

  /* Layout */
  #app{display:none}
  #main{padding:12px;max-width:900px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .btn{background:#fff;border:1px solid #d1d5db;border-radius:14px;padding:10px 14px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:8px}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.06)}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn.danger{background:#fff;color:var(--danger);border-color:#fecaca}
  .btn.ok{background:#fff;color:var(--ok);border-color:#bbf7d0}
  .muted{color:var(--muted);font-size:12px}
  .badge{font-size:11px;color:#0077ff;margin-inline-start:6px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}

  /* Login */
  #loginDiv{display:none;min-height:calc(100dvh - 56px);display:flex;align-items:center;justify-content:center}
  .login-card{width:min(460px,94%);background:#fff;border:1px solid var(--border);border-radius:18px;padding:18px}
  .login-title{margin:0 0 6px 0}
  .form-row{display:flex;flex-direction:column;margin:8px 0}
  .form-row input{padding:12px;border:1px solid #d1d5db;border-radius:12px}
  .sp{height:8px}

  /* Offline */
  #offline{display:none;height:100dvh;display:flex;align-items:center;justify-content:center;background:#fff}
  .offline-box{text-align:center}
  .offline-box img{width:60px;height:auto;display:block;margin:0 auto 10px}
  .offline-box .title{font-size:18px;margin:6px 0 10px}

  /* Side menu */
  .side-menu{position:fixed;top:56px;right:-320px;width:320px;height:calc(100% - 56px);background:#fff;border-left:1px solid var(--border);
    box-shadow:-2px 0 8px rgba(0,0,0,.06);transition:.25s;padding:12px;z-index:40;overflow:auto}
  .side-section{margin:10px 0}
  .pill{display:inline-flex;align-items:center;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;margin:4px 4px 0 0}

  /* Composer + posts */
  textarea.input{width:100%;min-height:90px;padding:10px;border:1px solid #e5e7eb;border-radius:12px;resize:vertical}
  .post{padding:10px 12px;border:1px solid #eef2f7;border-radius:14px;background:#fff;margin:10px 0}
  .post .meta{font-size:12px;color:#6b7280;margin-bottom:6px}

  /* Messenger */
  .chat-wrap{display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:76%;padding:10px 12px;border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
  .me{align-self:flex-start;background:#f1f5f9}
  .other{align-self:flex-end;background:#e2e8f0}
  .chat-box{height:300px;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px}
  .chat-input{display:flex;gap:8px}
  .chat-input input{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:12px}
</style>
</head>
<body>

<!-- NAV -->
<div class="navbar">
  <div class="logo"><span class="light">Saad</span><span class="bold">merabet</span></div>
  <div class="nav-icons">
    <span class="icon" id="icon-home" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ </span>
    <span class="icon" id="icon-chat" title="Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">ğŸ’¬</span>
    <span class="icon" id="icon-menu" title="Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±">â˜°</span>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† -->
<section id="offline">
  <div class="offline-box">
    <!-- ØµÙˆØ±Ø© 60px (SVG Base64 ØµØºÙŠØ±Ø©) -->
    <img alt="offline" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iMzUiIGN5PSI0MCIgcj0iMTUiIHN0cm9rZT0iI2IyYjJiMiIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iNjUiIGN5PSI0MCIgcj0iMTUiIHN0cm9rZT0iI2IyYjJiMiIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTMwIDY1IEM0MCA3MCA2MCA3MCA3MCA2NSIgc3Ryb2tlPSIjYjJiMmIyIiBzdHJva2Utd2lkdGg9IjQiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==" />
    <div class="title">No Internet</div>
    <button class="btn primary" onclick="location.reload()">Retry</button>
  </div>
</section>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<section id="loginDiv">
  <div class="login-card">
    <h3 class="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <p class="muted">Ø³Ø¬Ù‘Ù„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„ Ø£Ùˆ Ø¨Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ù„Ù„ØªØ¬Ø±Ø¨Ø©).</p>
    <div id="googleSignInDiv" style="margin:10px 0;"></div>
    <div class="form-row">
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="email" placeholder="example@gmail.com Ø£Ùˆ user123">
    </div>
    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <div class="sp"></div>
    <button class="btn primary" onclick="loginManual()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§</button>
    <div class="sp"></div>
    <div class="muted">Â© Ù…ÙˆÙ…Ù† â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø­Ù„ÙŠØ©</div>
  </div>
</section>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app">
  <div id="sideMenu" class="side-menu"></div>
  <main id="main"></main>
</div>

<script>
/* ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ================= */
const DEV_EMAIL = "moumen1392007@gmail.com"; // Ø£Ù†Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±
const GOOGLE_CLIENT_ID = "330919955917-lceq157045os9fv5f9ehuo0hidu856q1.apps.googleusercontent.com";

const ROLES_CAN_POST = ["publisher","moderator","developer"]; // Ù…Ù† ÙŠØ­Ù‚ Ù„Ù‡Ù… Ø§Ù„Ù†Ø´Ø±
const STORAGE_KEY = "moumen_app_state_v1";

/* ================= Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ================= */
function updateOnlineUI(){
  if(navigator.onLine){
    document.getElementById('offline').style.display='none';
    if(!currentUser){ document.getElementById('loginDiv').style.display='flex'; }
  }else{
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('app').style.display='none';
    document.getElementById('offline').style.display='flex';
  }
}
window.addEventListener('online', updateOnlineUI);
window.addEventListener('offline', updateOnlineUI);

/* ================= Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙØ­ÙØ¸ ÙÙŠ localStorage) ================= */
let state = {
  users: [],        // {username,email,role,sh3ba}
  posts: [],        // {id,user,role,sh3ba,text,ts}
  messages: [],     // {id,user,role,sh3ba,text,ts}
  currentUser: null // {username,email,role,sh3ba}
};
let currentUser = null;

function saveState(){
  try{
    state.currentUser = currentUser || null;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){ console.warn("saveState error", e); }
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      if(obj && typeof obj==="object"){
        state = Object.assign(state, obj);
        currentUser = state.currentUser;
      }
    }
  }catch(e){ console.warn("loadState error", e); }
}

/* ================= Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© ================= */
function uid(){ return Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,8); }
function fmtTime(ts){ const d=new Date(ts); return d.toLocaleString("ar-DZ"); }
function $(id){ return document.getElementById(id); }

/* ================= Ø±Ø¨Ø· Ø§Ù„Ù€ Navbar ================= */
function setActive(iconId){
  ["icon-home","icon-chat"].forEach(id=>{
    const el=$(id); if(!el) return;
    if(id===iconId) el.classList.add("active"); else el.classList.remove("active");
  });
}

/* ================= Google Sign-In ================= */
function parseJwt(token){
  var base64Url = token.split('.')[1];
  var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c){
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
  return JSON.parse(jsonPayload);
}
function handleCredentialResponse(resp){
  try{
    const data = parseJwt(resp.credential);
    const email = (data.email || '').toLowerCase();
    if(!email){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ù† Google'); return; }
    doLogin(email);
  }catch(e){
    console.error(e); alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„');
  }
}

/* ================= ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ================= */
function findUserByEmail(email){ return state.users.find(u=>u.email===email); }
function ensureUser(email){
  let u = findUserByEmail(email);
  if(!u){
    const role = (email.toLowerCase()===DEV_EMAIL.toLowerCase()) ? "developer" : "member";
    u = {username: email.split("@")[0], email, role, sh3ba: null};
    state.users.push(u);
  }
  return u;
}
function doLogin(emailOrUsername){
  const email = emailOrUsername.includes("@") ? emailOrUsername : (emailOrUsername + "@local");
  const u = ensureUser(email);
  // developer ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¶Ø­
  if(email.toLowerCase()===DEV_EMAIL.toLowerCase()){ u.role = "developer"; }
  currentUser = u;
  saveState();
  afterLogin();
}
function loginManual(){
  const val = ( $('email').value || '' ).trim();
  if(!val){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); return; }
  doLogin(val);
}
function afterLogin(){
  $('loginDiv').style.display='none';
  $('app').style.display='block';
  showHome();
}

/* ================= Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© ================= */
function sh3baPicker(){
  setActive("icon-home");
  $('main').innerHTML = `
    <h2 style="padding:8px 4px;margin:8px 0">Ø§Ø®ØªØ± Ø´Ø¹Ø¨ØªÙƒ (3 Ø«Ø§Ù†ÙˆÙŠ - Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)</h2>
    <div class="grid">
      <button class="btn" onclick="chooseSh3ba('Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©')">ğŸ”¬ Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
      <button class="btn" onclick="chooseSh3ba('Ø±ÙŠØ§Ø¶ÙŠØ§Øª')">ğŸ“ Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
      <button class="btn" onclick="toggleTech()">ğŸ› ï¸ ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ</button>
      <button class="btn" onclick="chooseSh3ba('ØªØ³ÙŠÙŠØ± ÙˆØ§Ù‚ØªØµØ§Ø¯')">ğŸ’¼ ØªØ³ÙŠÙŠØ± ÙˆØ§Ù‚ØªØµØ§Ø¯</button>
      <button class="btn" onclick="chooseSh3ba('Ø¢Ø¯Ø§Ø¨ ÙˆÙÙ„Ø³ÙØ©')">ğŸ“– Ø¢Ø¯Ø§Ø¨ ÙˆÙÙ„Ø³ÙØ©</button>
      <button class="btn" onclick="chooseSh3ba('Ù„ØºØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©')">ğŸŒ Ù„ØºØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</button>
    </div>
    <div id="techBox" class="card" style="display:none">
      <h3 style="margin:0 0 8px 0">ÙØ±ÙˆØ¹ ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ</h3>
      <div class="grid">
        <button class="btn" onclick="chooseSh3ba('ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯Ù†ÙŠØ©')">ğŸ—ï¸ Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯Ù†ÙŠØ©</button>
        <button class="btn" onclick="chooseSh3ba('ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©')">âš¡ Ù‡Ù†Ø¯Ø³Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</button>
        <button class="btn" onclick="chooseSh3ba('ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©')">âš™ï¸ Ù‡Ù†Ø¯Ø³Ø© Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©</button>
        <button class="btn" onclick="chooseSh3ba('ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ø±Ø§Ø¦Ù‚')">ğŸ”§ Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ø±Ø§Ø¦Ù‚</button>
      </div>
    </div>
  `;
}
function toggleTech(){
  const box = $('techBox'); if(!box) return;
  box.style.display = (box.style.display==='none'||box.style.display==='')?'block':'none';
}
function chooseSh3ba(s){
  currentUser.sh3ba = s;
  saveState();
  showHome();
}

/* ================= Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Timeline) ================= */
function canPost(u){
  return u && ROLES_CAN_POST.includes(u.role);
}
function showHome(){
  setActive("icon-home");
  if(!currentUser){ $('loginDiv').style.display='flex'; $('app').style.display='none'; return; }
  if(!currentUser.sh3ba){ sh3baPicker(); return; }

  const my = currentUser.sh3ba;
  const items = state.posts
    .map((p,idx)=>({p,idx}))
    .filter(x=>x.p.sh3ba===my)
    .sort((a,b)=>a.p.ts-b.p.ts);

  const list = items.map(({p,idx})=>{
    const canDel = (currentUser.role==="developer") || (currentUser.role==="moderator" && currentUser.sh3ba===p.sh3ba);
    const del = canDel ? `<button class="btn danger" onclick="deletePost('${p.id}')">Ø­Ø°Ù âŒ</button>` : "";
    return `<div class="post">
      <div class="meta"><b>${p.user}</b><span class="badge">${p.role}</span> â€¢ <span class="muted">${fmtTime(p.ts)}</span></div>
      <div>${p.text.replace(/</g,"&lt;")}</div>
      <div style="margin-top:8px">${del}</div>
    </div>`;
  }).join("");

  const composer = canPost(currentUser) ? `
    <div class="card">
      <h3 style="margin:0 0 8px 0">Ø£Ù†Ø´Ø¦ Ù…Ù†Ø´ÙˆØ±Ù‹Ø§ ÙÙŠ Ø´Ø¹Ø¨Ø©: ${my}</h3>
      <textarea id="postText" class="input" placeholder="Ø§ÙƒØªØ¨ Ù…Ù†Ø´ÙˆØ±Ùƒ..."></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn primary" onclick="addPost()">Ù†Ø´Ø±</button>
        <span class="muted">Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù… Ø¨Ø§Ù„Ù†Ø´Ø±: Ù…Ø·ÙˆÙ‘Ø±/Ù…Ø´Ø±Ù/Ù†Ø§Ø´Ø±</span>
      </div>
    </div>
  ` : `<div class="card"><span class="muted">Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø±. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± Ù…Ù†Ø­Ùƒ Ø¯ÙˆØ± "Ù†Ø§Ø´Ø±".</span></div>`;

  $('main').innerHTML = `
    <h2 style="margin:6px 0">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€” Ø´Ø¹Ø¨Ø© ${my}</h2>
    ${composer}
    ${list || '<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯.</div>'}
  `;
}
function addPost(){
  const t = $('postText');
  if(!t || !t.value.trim()){ return; }
  if(!canPost(currentUser)){ alert("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø´Ø±."); return; }
  state.posts.push({id:uid(), user:currentUser.username, role:currentUser.role, sh3ba:currentUser.sh3ba, text:t.value.trim(), ts:Date.now()});
  saveState();
  showHome();
}
function deletePost(id){
  state.posts = state.posts.filter(p=>p.id!==id);
  saveState();
  showHome();
}

/* ================= Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Messenger) ================= */
function showMessenger(){
  setActive("icon-chat");
  if(!currentUser){ $('loginDiv').style.display='flex'; $('app').style.display='none'; return; }
  if(!currentUser.sh3ba){ sh3baPicker(); return; }

  const my = currentUser.sh3ba;
  const msgs = state.messages
    .filter(m=>m.sh3ba===my)
    .sort((a,b)=>a.ts-b.ts)
    .map(m=>{
      const mine = (m.user===currentUser.username);
      const side = mine ? "me" : "other";
      const canDel = (currentUser.role==="developer") || (currentUser.role==="moderator" && currentUser.sh3ba===m.sh3ba);
      const del = canDel ? `<button class="btn danger" style="margin-top:6px" onclick="deleteMsg('${m.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>` : "";
      return `<div class="bubble ${side}">
        <div class="muted"><b>${m.user}</b><span class="badge">${m.role}</span> â€¢ ${fmtTime(m.ts)}</div>
        <div>${m.text.replace(/</g,"&lt;")}</div>
        ${del}
      </div>`;
    }).join("");

  $('main').innerHTML = `
    <h2 style="margin:6px 0">ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© â€” Ø´Ø¹Ø¨Ø© ${my}</h2>
    <div class="chat-box"><div class="chat-wrap">${msgs || 'Ø§Ø¨Ø¯Ø£ÙˆØ§ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†â€¦'}</div></div>
    <div class="card chat-input">
      <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©â€¦">
      <button class="btn primary" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  `;
  // ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  const box = document.querySelector(".chat-box"); if(box) box.scrollTop = box.scrollHeight;
}
function sendMsg(){
  const i = $('msgInput');
  if(!i || !i.value.trim()) return;
  state.messages.push({id:uid(), user:currentUser.username, role:currentUser.role, sh3ba:currentUser.sh3ba, text:i.value.trim(), ts:Date.now()});
  saveState();
  showMessenger();
}
function deleteMsg(id){
  state.messages = state.messages.filter(m=>m.id!==id);
  saveState();
  showMessenger();
}

/* ================= Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± (â˜°) ================= */
function toggleMenu(){
  const menu = $('sideMenu'); if(!menu) return;
  menu.style.right = (menu.style.right==="0px") ? "-320px" : "0px";
  if(menu.style.right==="0px"){ renderMenu(); }
}
function renderMenu(){
  const m = $('sideMenu'); if(!m) return;
  if(!currentUser || currentUser.role!=="developer"){
    m.innerHTML = `<div class="card">Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ù„Ù…Ø·ÙˆÙ‘Ø± ÙÙ‚Ø·.</div>`;
    return;
  }
  const usersList = state.users.map(u=>`
    <div class="card">
      <div><b>${u.username}</b> <span class="badge">${u.role}</span></div>
      <div class="muted">${u.email}</div>
      <div class="side-section">
        <div class="muted">Ø´Ø¹Ø¨Ø©: ${u.sh3ba || 'Ù„Ù… ØªÙØ­Ø¯Ù‘Ø¯'}</div>
        <div class="grid" style="margin-top:6px">
          <button class="btn" onclick="setSh3ba('${u.email}','Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©')">Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
          <button class="btn" onclick="setSh3ba('${u.email}','Ø±ÙŠØ§Ø¶ÙŠØ§Øª')">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</button>
          <button class="btn" onclick="setSh3ba('${u.email}','ØªØ³ÙŠÙŠØ± ÙˆØ§Ù‚ØªØµØ§Ø¯')">ØªØ³ÙŠÙŠØ± ÙˆØ§Ù‚ØªØµØ§Ø¯</button>
          <button class="btn" onclick="setSh3ba('${u.email}','Ø¢Ø¯Ø§Ø¨ ÙˆÙÙ„Ø³ÙØ©')">Ø¢Ø¯Ø§Ø¨ ÙˆÙÙ„Ø³ÙØ©</button>
          <button class="btn" onclick="setSh3ba('${u.email}','Ù„ØºØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©')">Ù„ØºØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</button>
          <button class="btn" onclick="setSh3ba('${u.email}','ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯Ù†ÙŠØ©')">ØªÙ‚Ù†ÙŠ/Ù…Ø¯Ù†ÙŠØ©</button>
          <button class="btn" onclick="setSh3ba('${u.email}','ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©')">ØªÙ‚Ù†ÙŠ/ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</button>
          <button class="btn" onclick="setSh3ba('${u.email}','ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©')">ØªÙ‚Ù†ÙŠ/Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©</button>
          <button class="btn" onclick="setSh3ba('${u.email}','ØªÙ‚Ù†ÙŠ Ø±ÙŠØ§Ø¶ÙŠ - Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ø±Ø§Ø¦Ù‚')">ØªÙ‚Ù†ÙŠ/Ø§Ù„Ø·Ø±Ø§Ø¦Ù‚</button>
        </div>
      </div>
      <div class="side-section">
        <div class="muted">ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±:</div>
        <div class="pill">member</div>
        <button class="btn" onclick="setRole('${u.email}','member')">ØªØ¹ÙŠÙŠÙ†</button>
        <div class="pill">publisher</div>
        <button class="btn ok" onclick="setRole('${u.email}','publisher')">ØªØ¹ÙŠÙŠÙ†</button>
        <div class="pill">moderator</div>
        <button class="btn" onclick="setRole('${u.email}','moderator')">ØªØ¹ÙŠÙŠÙ†</button>
      </div>
    </div>
  `).join("");

  m.innerHTML = `
    <h3 style="margin:6px 0 10px">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</h3>
    <div class="card">
      <div><b>Ø£Ù†Øª:</b> ${currentUser.username} <span class="badge">${currentUser.role}</span></div>
      <div class="muted">Ø´Ø¹Ø¨ØªÙƒ: ${currentUser.sh3ba || 'ØºÙŠØ± Ù…Ø­Ø¯Ù‘Ø¯Ø©'}</div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="chooseSh3baPrompt()">ØªØºÙŠÙŠØ± Ø´Ø¹Ø¨ØªÙŠ</button>
        <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <button class="btn danger" onclick="clearAll()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
    ${usersList || '<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ø¹Ø¯.</div>'}
  `;
}
function setRole(email,newRole){
  const u = state.users.find(x=>x.email===email);
  if(u){ u.role=newRole; saveState(); renderMenu(); alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±: "+newRole); }
}
function setSh3ba(email,newSh3ba){
  const u = state.users.find(x=>x.email===email);
  if(u){ u.sh3ba=newSh3ba; saveState(); renderMenu(); }
}
function chooseSh3baPrompt(){
  const s = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø¨Ø¯Ù‚Ø©:", currentUser.sh3ba||"Ø¹Ù„ÙˆÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ©");
  if(!s) return;
  currentUser.sh3ba = s;
  const u = state.users.find(x=>x.email===currentUser.email);
  if(u){ u.sh3ba = s; }
  saveState();
  showHome();
}

/* ================= Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ================= */
function logout(){
  currentUser = null;
  state.currentUser = null;
  saveState();
  $('app').style.display='none';
  $('loginDiv').style.display='flex';
  setActive(null);
}
function clearAll(){
  if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ")) {
    localStorage.removeItem(STORAGE_KEY);
    state = {users:[],posts:[],messages:[],currentUser:null};
    currentUser = null;
    location.reload();
  }
}

/* ================= ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ================= */
document.addEventListener("DOMContentLoaded", ()=>{
  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø±
  const h=$('icon-home'), c=$('icon-chat'), m=$('icon-menu');
  if(h) h.addEventListener('click', showHome);
  if(c) c.addEventListener('click', showMessenger);
  if(m) m.addEventListener('click', toggleMenu);
});

window.addEventListener("load", ()=>{
  updateOnlineUI();
  loadState();

  // ØªÙ‡ÙŠØ¦Ø© Ø¬ÙˆØ¬Ù„
  if(typeof google!=="undefined"){
    try{
      google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
      google.accounts.id.renderButton($("googleSignInDiv"), { theme:"outline", size:"large" });
    }catch(e){ console.warn("Google init error", e); }
  }else{
    const div=$("googleSignInDiv");
    if(div){ div.innerHTML='<div class="muted">Ø²Ø± Google Ø³ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„.</div>'; }
  }

  // Ù„Ùˆ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ù‹Ø§
  if(currentUser){
    $('loginDiv').style.display='none';
    $('app').style.display='block';
    showHome();
  }
});
</script>
</body>
</html>
